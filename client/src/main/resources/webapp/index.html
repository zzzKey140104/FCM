<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LTM Push Console</title>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
    .container { max-width: 980px; }
    .token-cell { font-family: monospace; font-size: 12px; word-break: break-all; }
    .navbar-brand { font-weight: bold; }
    .btn-group .btn { margin-right: 5px; }
    .table th { background-color: #f5f5f5; }
    .form-control { margin-bottom: 10px; }
    .output-log { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-default">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">
                    <i class="fa fa-mobile"></i> LTM Push Console
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h3><i class="fa fa-list"></i> Thi·∫øt b·ªã ƒë√£ ƒëƒÉng k√Ω</h3>
                <div class="btn-group" style="margin-bottom:15px;">
                    <button id="btnReload" class="btn btn-primary">
                        <i class="fa fa-refresh"></i> T·∫£i l·∫°i
                    </button>
                    <button id="btnSelectAll" class="btn btn-success">
                        <i class="fa fa-check-square-o"></i> Ch·ªçn t·∫•t c·∫£
                    </button>
                    <button id="btnClear" class="btn btn-warning">
                        <i class="fa fa-square-o"></i> B·ªè ch·ªçn
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th style="width:40px">
                                    <input type="checkbox" id="selectAllCheckbox">
                                </th>
                                <th style="width:80px">ID</th>
                                <th style="width:220px">Label</th>
                                <th>Token</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTbody">
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    <i class="fa fa-spinner fa-spin"></i> ƒêang t·∫£i danh s√°ch thi·∫øt b·ªã...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <hr>
        
        <div class="row">
            <div class="col-md-12">
                <h3><i class="fa fa-paper-plane"></i> G·ª≠i th√¥ng b√°o</h3>
                <form id="sendForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="title">Ti√™u ƒë·ªÅ:</label>
                                <input type="text" id="title" class="form-control" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ th√¥ng b√°o">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="body">N·ªôi dung:</label>
                                <input type="text" id="body" class="form-control" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="submit" id="btnSend" class="btn btn-primary btn-lg">
                            <i class="fa fa-send"></i> G·ª≠i th√¥ng b√°o
                        </button>
                        <span id="selectedCount" class="text-muted" style="margin-left: 15px;"></span>
                    </div>
                </form>
                
                <div class="output-log">
                    <h5><i class="fa fa-terminal"></i> K·∫øt qu·∫£:</h5>
                    <pre id="output" style="height:160px; overflow:auto; margin:0;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/jquery-2.1.3.min.js"></script>
    <script src="/assets/js/bootstrap.js"></script>
    <script>
        $(document).ready(function() {
            loadDevices();
            updateSelectedCount();
        });
        
        function loadDevices() {
            $('#deviceTbody').html('<tr><td colspan="4" class="text-center text-muted"><i class="fa fa-spinner fa-spin"></i> ƒêang t·∫£i...</td></tr>');
            
            $.getJSON('/api/devices')
                .done(function(response) {
                    var data = parseResponse(response);
                    if (data && Array.isArray(data)) {
                        displayDevices(data);
                    } else {
                        appendOut('L·ªói: Kh√¥ng th·ªÉ parse d·ªØ li·ªáu thi·∫øt b·ªã');
                        $('#deviceTbody').html('<tr><td colspan="4" class="text-center text-danger">Kh√¥ng c√≥ thi·∫øt b·ªã n√†o</td></tr>');
                    }
                })
                .fail(function(xhr) {
                    appendOut('L·ªói t·∫£i danh s√°ch: ' + xhr.status + ': ' + xhr.responseText);
                    $('#deviceTbody').html('<tr><td colspan="4" class="text-center text-danger">L·ªói t·∫£i danh s√°ch thi·∫øt b·ªã</td></tr>');
                });
        }
        
        function parseResponse(response) {
            if (typeof response === 'string') {
                var parts = response.split(':', 2);
                if (parts.length === 2) {
                    var statusCode = parseInt(parts[0]);
                    var body = parts[1];
                    if (statusCode === 200) {
                        try {
                            return JSON.parse(body);
                        } catch (e) {
                            appendOut('L·ªói parse JSON: ' + e.message);
                            return null;
                        }
                    } else {
                        appendOut('Server error: ' + statusCode + ' - ' + body);
                        return null;
                    }
                }
            }
            return response;
        }
        
        function displayDevices(devices) {
            var $tb = $('#deviceTbody').empty();
            if (devices.length === 0) {
                $tb.append('<tr><td colspan="4" class="text-center text-muted">Kh√¥ng c√≥ thi·∫øt b·ªã n√†o ƒë∆∞·ª£c ƒëƒÉng k√Ω</td></tr>');
                return;
            }
            
            devices.forEach(function(d) {
                var tr = $('<tr/>');
                tr.append('<td><input type="checkbox" class="pick" data-id="' + d.id + '"></td>');
                tr.append('<td>' + d.id + '</td>');
                tr.append('<td>' + (d.label || '') + '</td>');
                tr.append('<td class="token-cell">' + d.token + '</td>');
                $tb.append(tr);
            });
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            var count = $('.pick:checked').length;
            var total = $('.pick').length;
            $('#selectedCount').text('ƒê√£ ch·ªçn: ' + count + '/' + total + ' thi·∫øt b·ªã');
        }
        
        function appendOut(s) {
            var $o = $('#output');
            var timestamp = new Date().toLocaleTimeString();
            $o.text($o.text() + '[' + timestamp + '] ' + s + '\n');
            $o.scrollTop($o.prop('scrollHeight'));
        }
        
        function send() {
            var ids = [];
            $('.pick:checked').each(function() { 
                ids.push($(this).data('id')); 
            });
            
            if (ids.length === 0) { 
                appendOut('‚ùå Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 thi·∫øt b·ªã'); 
                return; 
            }
            
            var title = $('#title').val() || '';
            var body = $('#body').val() || '';
            
            if (!title && !body) {
                appendOut('‚ùå Vui l√≤ng nh·∫≠p ti√™u ƒë·ªÅ ho·∫∑c n·ªôi dung');
                return;
            }
            
            appendOut('üì§ ƒêang g·ª≠i th√¥ng b√°o ƒë·∫øn ' + ids.length + ' thi·∫øt b·ªã...');
            
            // Build form data as object with array
            var formData = {
                title: title,
                body: body,
                'ids[]': ids
            };
            
            $.ajax({
                url: '/api/send',
                method: 'POST',
                data: formData,
                traditional: true, // This is important for array serialization
                success: function(response) {
                    var result = parseResponse(response);
                    if (result && result.success) {
                        appendOut('‚úÖ ' + result.message);
                        if (result.details) {
                            appendOut('üìã Chi ti·∫øt: ' + JSON.stringify(result.details));
                        }
                    } else if (result && result.result) {
                        appendOut('‚úÖ G·ª≠i th√†nh c√¥ng: ' + result.result);
                    } else if (result && result.error) {
                        appendOut('‚ùå L·ªói: ' + result.error);
                    } else {
                        appendOut('üìã K·∫øt qu·∫£: ' + response);
                    }
                },
                error: function(xhr) {
                    appendOut('‚ùå L·ªói g·ª≠i: ' + xhr.status + ': ' + xhr.responseText);
                }
            });
        }
        
        // Event handlers
        $('#btnReload').on('click', loadDevices);
        $('#btnSelectAll').on('click', function() { 
            $('.pick').prop('checked', true); 
            updateSelectedCount();
        });
        $('#btnClear').on('click', function() { 
            $('.pick').prop('checked', false); 
            updateSelectedCount();
        });
        $('#selectAllCheckbox').on('change', function() {
            $('.pick').prop('checked', this.checked);
            updateSelectedCount();
        });
        $(document).on('change', '.pick', updateSelectedCount);
        $('#sendForm').on('submit', function(e) {
            e.preventDefault();
            send();
        });
    </script>
</body>
</html>
